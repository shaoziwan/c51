C51 COMPILER V9.00   CHENGXU                                                               04/19/2020 18:38:59 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE CHENGXU
OBJECT MODULE PLACED IN chengxu.OBJ
COMPILER INVOKED BY: E:\学习\C51\BIN\C51.EXE chengxu.c LARGE BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /******************************************************
   2          ******************************************************/
   3          #include <REG51.H>
   4          #include <intrins.h>
   5          #define uint unsigned int
   6          #define uchar unsigned char
   7          //延时子程序模块
   8          //**********************************************
   9          void mdelay(uint delay)
  10          {
  11   1          uint i;
  12   1          for(; delay>0; delay--)
  13   1          {
  14   2              for(i=0; i<80; i++) //1ms延时.
  15   2              {
  16   3                  ;
  17   3              }
  18   2          }
  19   1      }
  20          
  21          //************************************************
  22          
  23          void show();   //液晶显示程序
  24          //****************************************
  25          //12864液晶显示部分子程序模块
  26          //****************************************
  27          sbit K8         = P0^4;
  28          sbit K7         = P0^3;
  29          sbit K6         = P0^2;
  30          
  31          sbit K5         = P0^1;
  32          sbit K4         = P0^0;
  33          
  34          sbit K1         = P1^0;
  35          
  36          sbit K2         = P1^1;
  37          sbit K3         = P1^2;
  38          
  39          
  40          sbit K11        = P3^2;
  41          sbit K12        = P3^3;
  42          sbit K13        = P3^4;
  43          sbit K14        = P3^5;
  44          sbit K15        = P3^6;
  45          
  46          
  47          
  48          sbit DJ=P1^4;
  49          
  50          sbit rs         = P0^5;
  51          sbit rw         = P0^6;
  52          sbit e          = P0^7;
  53          sbit beep = P1^5;
  54          #define lcddata P2
  55          
C51 COMPILER V9.00   CHENGXU                                                               04/19/2020 18:38:59 PAGE 2   

  56          unsigned char count=0,m=30,n,nn,money=0,du;                     //定义计数变量
  57          
  58          uchar t1=0,t2=5,t3=5,t4=5,t5=0;
  59          
  60          uchar Time[6];
  61          
  62          uchar info[] = "hello world";
  63          uchar atTest[] = "AT\r\n" ;
  64          uchar atMUX[] = "AT+CIPMUX=1\r\n" ;
  65          uchar atServer[] = "AT+CIPSERVER=1,8008\r\n" ;
  66          uchar sendList[] = "AT+CIPSEND=0,5\r\n";
  67          uchar sendSTATUS[]= "AT+CIPSEND=0,1\r\n";
  68          uchar configStep = 0;
  69          
  70          uchar recvData[10]={0};
  71          uchar readFinish = 0;
  72          
  73          sbit busy=P0^7;   //lcd busy bit
  74          void wr_d_lcd(uchar content);
  75          void wr_i_lcd(uchar content);
  76          void clrram_lcd (void);
  77          void init_lcd(void);
  78          void busy_lcd(void);
  79          void rev_row_lcd(uchar row);
  80          void rev_co_lcd(uchar row,uchar col,uchar mode);
  81          void clr_lcd(void);
  82          void wr_co_lcd(uchar row,uchar col,uchar lcddata1,uchar lcddtta2);
  83          void wr_row_lcd(uchar row,char *p);
  84          //*******************************************************************                                     
             -                           */
  85          //因为引脚的定义DB0..DB7是从P1.7...P1.0排列的                                                    */
  86          //所以顺序需要调换一下
  87          //*******************************************************************
  88          uchar swapbit(uchar udata)
  89          {
  90   1          uchar ii,tmp=0;
  91   1          for(ii=0; ii<8; ii++)
  92   1          {
  93   2              tmp<<=1;
  94   2              if(udata&0x01)
  95   2              {
  96   3                  tmp|=0x01;
  97   3              }
  98   2              udata>>=1;
  99   2          }
 100   1          return tmp;
 101   1      }
 102          //**********************************
 103          //液晶初始化
 104          //**********************************
 105          void init_lcd(void)
 106          {
 107   1          wr_i_lcd(0x06);  /*光标的移动方向*/
 108   1          wr_i_lcd(0x0c);  /*开显示，关游标*/
 109   1      }
 110          //***********************************
 111          //填充液晶DDRAM全为空格
 112          //**********************************
 113          void clrram_lcd (void)
 114          {
 115   1          wr_i_lcd(0x30);
 116   1          wr_i_lcd(0x01);
C51 COMPILER V9.00   CHENGXU                                                               04/19/2020 18:38:59 PAGE 3   

 117   1      }
 118          //***********************************
 119          //对液晶写数据
 120          //content为要写入的数据
 121          //***********************************
 122          void wr_d_lcd(uchar content)
 123          {
 124   1      //      busy_lcd();
 125   1          rs=1;
 126   1          rw=0;
 127   1          lcddata=swapbit(content);
 128   1          e=1;
 129   1          ;
 130   1          e=0;
 131   1      }
 132          //********************************
 133          //对液晶写指令
 134          //content为要写入的指令代码
 135          //*****************************
 136          void wr_i_lcd(uchar content)
 137          {
 138   1      //      busy_lcd();
 139   1          rs=0;
 140   1          rw=0;
 141   1          lcddata=swapbit(content);
 142   1          e=1;
 143   1          ;
 144   1          e=0;
 145   1      }
 146          //********************************
 147          //液晶检测忙状态
 148          //在写入之前必须执行
 149          //********************************
 150          void busy_lcd(void)
 151          {
 152   1          lcddata=0xff;
 153   1          rs=0;
 154   1          rw=1;
 155   1          e =1;
 156   1          while(busy==1);
 157   1          e =0;
 158   1      }
 159          //********************************
 160          //指定要显示字符的坐标
 161          //*******************************
 162          void gotoxy(unsigned char y, unsigned char x)
 163          {
 164   1          if(y==1)
 165   1              wr_i_lcd(0x80|x);
 166   1          if(y==2)
 167   1              wr_i_lcd(0x90|x);
 168   1          if(y==3)
 169   1              wr_i_lcd((0x80|x)+8);
 170   1          if(y==4)
 171   1              wr_i_lcd((0x90|x)+8);
 172   1      }
 173          //**********************************
 174          //液晶显示字符串程序
 175          //**********************************
 176          void print(uchar *str)
 177          {
 178   1          while(*str!='\0')
C51 COMPILER V9.00   CHENGXU                                                               04/19/2020 18:38:59 PAGE 4   

 179   1          {
 180   2              wr_d_lcd(*str);
 181   2              str++;
 182   2          }
 183   1      }
 184          
 185          //***************************************
 186          //液晶显示主程序模块
 187          //***************************************
 188          void show()
 189          {         
 190   1          if(nn<10)
 191   1          {
 192   2              gotoxy(1,0);
 193   2              print("按键选择货物：   ");
 194   2              mdelay(10);
 195   2                      
 196   2      
 197   2      
 198   2      
 199   2              gotoxy(2,0);
 200   2              print("①矿泉水(1元)  ");
 201   2              mdelay(10); 
 202   2      
 203   2                      Time[0]=t1+'0';
 204   2              Time[1]='\0';
 205   2              gotoxy(2,7);
 206   2                      print(Time);
 207   2                      
 208   2                     
 209   2      
 210   2      
 211   2      
 212   2      
 213   2              gotoxy(3,0);
 214   2              print("②红茶(3元)   ");
 215   2              mdelay(10);     //扫描延时
 216   2      
 217   2                      Time[0]=t2+'0';
 218   2            
 219   2              Time[1]='\0';
 220   2              gotoxy(3,7);
 221   2                      print(Time);
 222   2      
 223   2      
 224   2              gotoxy(4,0);
 225   2              print("③绿茶(4元)  ");
 226   2              mdelay(10);                 //扫描延时
 227   2      
 228   2                      Time[0]=t3+'0';
 229   2              Time[1]='\0';
 230   2              gotoxy(4,7);
 231   2                      print(Time);
 232   2      
 233   2      
 234   2      
 235   2          }
 236   1          if(nn==10)
 237   1              { clrram_lcd ();}
 238   1          if(nn>=11)
 239   1          {
 240   2      
C51 COMPILER V9.00   CHENGXU                                                               04/19/2020 18:38:59 PAGE 5   

 241   2              gotoxy(1,0);
 242   2              print("④啤酒(5元)  ");
 243   2              mdelay(10);
 244   2      
 245   2                      Time[0]=t4+'0';
 246   2              Time[1]='\0';
 247   2              gotoxy(1,7);
 248   2                      print(Time);
 249   2      
 250   2              gotoxy(2,0);
 251   2              print("⑤红牛(6元)  ");
 252   2              mdelay(10);                 //扫描延时
 253   2      
 254   2                      Time[0]=t5+'0';
 255   2              Time[1]='\0';
 256   2              gotoxy(2,7);
 257   2                      print(Time);
 258   2      
 259   2              gotoxy(3,0);
 260   2              print("选定后投入硬币");
 261   2              mdelay(10);     //扫描延时
 262   2          }
 263   1      
 264   1      }
 265          
 266          //***************************************
 267          //按键选择货物
 268          //***************************************
 269          
 270          void key()
 271          {
 272   1          
 273   1                if(K11==0)
 274   1                  {
 275   2                      while(K11==0);
 276   2                      mdelay(10);
 277   2                      t1=t1+1;
 278   2                  }
 279   1                              else if(K12==0)
 280   1                  {
 281   2                      while(K12==0);
 282   2                      mdelay(10);
 283   2                      t2=t2+1;
 284   2                  }
 285   1                                      else if(K13==0)
 286   1                  {
 287   2                      while(K13==0);
 288   2                      mdelay(10);
 289   2                      t3=t3+1;
 290   2                  }
 291   1                                      else if(K14==0)
 292   1                  {
 293   2                      while(K14==0);
 294   2                      mdelay(10);
 295   2                      t4=t4+1;
 296   2                  }
 297   1                                      else if(K15==0)
 298   1                  {
 299   2                      while(K15==0);
 300   2                      mdelay(10);
 301   2                      t5=t5+1;
 302   2                  }
C51 COMPILER V9.00   CHENGXU                                                               04/19/2020 18:38:59 PAGE 6   

 303   1                              
 304   1                                      
 305   1              
 306   1              
 307   1              if(K4==0)//按键1
 308   1          {   
 309   2                  if(t1>0)
 310   2                      {  t1--;
 311   3                      m=30;
 312   3              clrram_lcd ();
 313   3              while(1)
 314   3              {
 315   4                  if(m==6)beep=0;
 316   4                  if(m==5)beep=1;
 317   4                  if(m==0)
 318   4                  {
 319   5                      if(0<money)
 320   5                      {
 321   6                          clrram_lcd ();
 322   6                          gotoxy(1,0);
 323   6                          print("投币不足购买失败");
 324   6                          mdelay(10);
 325   6                          gotoxy(2,0);
 326   6                          print("退钱：    元");
 327   6                          mdelay(10);
 328   6                          Time[0]=money/10+'0';
 329   6                          Time[1]='.';
 330   6                          Time[2]=money%10+'0';
 331   6                          Time[3]='\0';
 332   6                          gotoxy(2,3);
 333   6                          print(Time);
 334   6                          mdelay(6000);
 335   6                          money=0;
 336   6                      }
 337   5      
 338   5                      clrram_lcd ();
 339   5                      break;
 340   5                  }
 341   4      
 342   4                  gotoxy(1,0);
 343   4                  print("已选矿泉水");
 344   4                  mdelay(10);
 345   4      
 346   4                  gotoxy(2,0);
 347   4                  print("货物价格:1元");
 348   4                  mdelay(10);
 349   4      
 350   4                  gotoxy(3,0);
 351   4                  print("投币金额:     元");
 352   4                  mdelay(10);
 353   4      
 354   4                  gotoxy(4,0);
 355   4                  print("规定时间：");
 356   4                  mdelay(10);
 357   4      
 358   4      
 359   4                  if(n==0)
 360   4                  {
 361   5                      gotoxy(3,5);
 362   5                      print(Time);
 363   5                      mdelay(100);
 364   5                  }
C51 COMPILER V9.00   CHENGXU                                                               04/19/2020 18:38:59 PAGE 7   

 365   4      
 366   4                  if(n==1)
 367   4                  {
 368   5                      gotoxy(4,7);
 369   5                      print(Time);
 370   5                      mdelay(10);
 371   5                  }
 372   4      
 373   4                  if(K1==0)
 374   4                  {
 375   5                      while(K1==0);
 376   5                      mdelay(10);
 377   5                      money=money+100;
 378   5                  }
 379   4      
 380   4                  if(K2==0)
 381   4                  {
 382   5                      while(K2==0);
 383   5                      mdelay(10);
 384   5                      money=money+50;
 385   5                  }
 386   4      
 387   4                  if(K3==0)
 388   4                  {
 389   5                      while(K3==0);
 390   5                      mdelay(10);
 391   5                      money=money+10;
 392   5                  }
 393   4                  if(money>=10)
 394   4                  {
 395   5                      clrram_lcd ();
 396   5                      gotoxy(1,0);
 397   5                      print("矿泉水购买成功");
 398   5                      mdelay(10);
 399   5                      gotoxy(2,0);
 400   5                      print("找钱：    元");
 401   5                      mdelay(10);
 402   5      
 403   5                      du=money-10;
 404   5                      Time[0]=du/10+'0';
 405   5                      Time[1]='.';
 406   5                      Time[2]=du%10+'0';
 407   5                      Time[3]='\0';
 408   5                      gotoxy(2,3);
 409   5                      print(Time);
 410   5                                      DJ=0;
 411   5                      mdelay(6000);
 412   5                                      DJ=1;
 413   5                      money=0;
 414   5                      clrram_lcd ();
 415   5                      break;
 416   5      
 417   5                  }
 418   4              }
 419   3                      }
 420   2          }
 421   1      
 422   1      
 423   1          if(K5==0)//按键2
 424   1          {   if(t2>0)
 425   2                      {  t2--;
 426   3              
C51 COMPILER V9.00   CHENGXU                                                               04/19/2020 18:38:59 PAGE 8   

 427   3                      m=30;
 428   3              clrram_lcd ();
 429   3              while(1)
 430   3              {
 431   4                  if(m==6)beep=0;
 432   4                  if(m==5)beep=1;
 433   4                  if(m==0)
 434   4                  {
 435   5                      if(0<money<30)
 436   5                      {
 437   6                          clrram_lcd ();
 438   6                          gotoxy(1,0);
 439   6                          print("投币不足购买失败");
 440   6                          mdelay(10);
 441   6                          gotoxy(2,0);
 442   6                          print("退钱：    元");
 443   6                          mdelay(10);
 444   6                          Time[0]=money/10+'0';
 445   6                          Time[1]='.';
 446   6                          Time[2]=money%10+'0';
 447   6                          Time[3]='\0';
 448   6                          gotoxy(2,3);
 449   6                          print(Time);
 450   6                          mdelay(6000);
 451   6                          money=0;
 452   6                      }
 453   5      
 454   5                      clrram_lcd ();
 455   5                      break;
 456   5                  }
 457   4      
 458   4                  gotoxy(1,0);
 459   4                  print("已选红茶");
 460   4                  mdelay(10);
 461   4      
 462   4                  gotoxy(2,0);
 463   4                  print("货物价格:3元");
 464   4                  mdelay(10);
 465   4      
 466   4                  gotoxy(3,0);
 467   4                  print("投币金额:     元");
 468   4                  mdelay(10);
 469   4      
 470   4                  gotoxy(4,0);
 471   4                  print("规定时间：");
 472   4                  mdelay(10);
 473   4      
 474   4      
 475   4                  if(n==0)
 476   4                  {
 477   5                      gotoxy(3,5);
 478   5                      print(Time);
 479   5                      mdelay(100);
 480   5                  }
 481   4      
 482   4                  if(n==1)
 483   4                  {
 484   5                      gotoxy(4,7);
 485   5                      print(Time);
 486   5                      mdelay(10);
 487   5                  }
 488   4      
C51 COMPILER V9.00   CHENGXU                                                               04/19/2020 18:38:59 PAGE 9   

 489   4                  if(K1==0)
 490   4                  {
 491   5                      while(K1==0);
 492   5                      mdelay(10);
 493   5                      money=money+100;
 494   5                  }
 495   4      
 496   4                  if(K2==0)
 497   4                  {
 498   5                      while(K2==0);
 499   5                      mdelay(10);
 500   5                      money=money+50;
 501   5                  }
 502   4      
 503   4                  if(K3==0)
 504   4                  {
 505   5                      while(K3==0);
 506   5                      mdelay(10);
 507   5                      money=money+10;
 508   5                  }
 509   4                  if(money>=30)
 510   4                  {
 511   5                      clrram_lcd ();
 512   5                      gotoxy(1,0);
 513   5                      print("红茶购买成功");
 514   5                      mdelay(10);
 515   5                      gotoxy(2,0);
 516   5                      print("找钱：    元");
 517   5                      mdelay(10);
 518   5      
 519   5                      du=money-30;
 520   5                      Time[0]=du/10+'0';
 521   5                      Time[1]='.';
 522   5                      Time[2]=du%10+'0';
 523   5                      Time[3]='\0';
 524   5                      gotoxy(2,3);
 525   5                      print(Time);
 526   5                                      DJ=0;
 527   5                      mdelay(6000);
 528   5                                      DJ=1;
 529   5                    
 530   5                      money=0;
 531   5                      clrram_lcd ();
 532   5                      break;
 533   5      
 534   5                  }
 535   4              }
 536   3                      }
 537   2      
 538   2          }
 539   1      
 540   1      
 541   1      
 542   1          if(K6==0)//按键3
 543   1          {   if(t3>0)
 544   2                      {  t3--;
 545   3              m=30;
 546   3              clrram_lcd ();
 547   3                      while(1)
 548   3              {
 549   4                              if(m==6)beep=0;
 550   4                  if(m==5)beep=1;
C51 COMPILER V9.00   CHENGXU                                                               04/19/2020 18:38:59 PAGE 10  

 551   4                  if(m==0)
 552   4                  {
 553   5                      if(0<money<40)
 554   5                      {
 555   6                          clrram_lcd ();
 556   6                          gotoxy(1,0);
 557   6                          print("投币不足购买失败");
 558   6                          mdelay(10);
 559   6                          gotoxy(2,0);
 560   6                          print("退钱：    元");
 561   6                          mdelay(10);
 562   6                          Time[0]=money/10+'0';
 563   6                          Time[1]='.';
 564   6                          Time[2]=money%10+'0';
 565   6                          Time[3]='\0';
 566   6                          gotoxy(2,3);
 567   6                          print(Time);
 568   6                          mdelay(6000);
 569   6                          money=0;
 570   6                      }
 571   5      
 572   5                      clrram_lcd ();
 573   5                      break;
 574   5                  }
 575   4      
 576   4                  gotoxy(1,0);
 577   4                  print("已选绿茶");
 578   4                  mdelay(10);
 579   4      
 580   4                  gotoxy(2,0);
 581   4                  print("货物价格:4元");
 582   4                  mdelay(10);
 583   4      
 584   4                  gotoxy(3,0);
 585   4                  print("投币金额:     元");
 586   4                  mdelay(10);
 587   4      
 588   4                  gotoxy(4,0);
 589   4                  print("规定时间：");
 590   4                  mdelay(10);
 591   4      
 592   4      
 593   4                  if(n==0)
 594   4                  {
 595   5                      gotoxy(3,5);
 596   5                      print(Time);
 597   5                      mdelay(100);
 598   5                  }
 599   4      
 600   4                  if(n==1)
 601   4                  {
 602   5                      gotoxy(4,7);
 603   5                      print(Time);
 604   5                      mdelay(10);
 605   5                  }
 606   4      
 607   4                  if(K1==0)
 608   4                  {
 609   5                      while(K1==0);
 610   5                      mdelay(10);
 611   5                      money=money+100;
 612   5                  }
C51 COMPILER V9.00   CHENGXU                                                               04/19/2020 18:38:59 PAGE 11  

 613   4      
 614   4                  if(K2==0)
 615   4                  {
 616   5                      while(K2==0);
 617   5                      mdelay(10);
 618   5                      money=money+50;
 619   5                  }
 620   4      
 621   4                  if(K3==0)
 622   4                  {
 623   5                      while(K3==0);
 624   5                      mdelay(10);
 625   5                      money=money+10;
 626   5                  }
 627   4                  if(money>=40)
 628   4                  {
 629   5                      clrram_lcd ();
 630   5                      gotoxy(1,0);
 631   5                      print("绿茶购买成功");
 632   5                      mdelay(10);
 633   5                      gotoxy(2,0);
 634   5                      print("找钱：    元");
 635   5                      mdelay(10);
 636   5      
 637   5                      du=money-40;
 638   5                      Time[0]=du/10+'0';
 639   5                      Time[1]='.';
 640   5                      Time[2]=du%10+'0';
 641   5                      Time[3]='\0';
 642   5                      gotoxy(2,3);
 643   5                      print(Time);
 644   5                                       DJ=0;
 645   5                      mdelay(6000);
 646   5                                      DJ=1;
 647   5                     
 648   5                      money=0;
 649   5                      clrram_lcd ();
 650   5                      break;
 651   5      
 652   5                  }
 653   4              }
 654   3                      }
 655   2      
 656   2          }
 657   1      
 658   1      
 659   1      
 660   1          if(K7==0)//按键4
 661   1          {   if(t4>0)
 662   2                      {       t4--;
 663   3              m=30;
 664   3              clrram_lcd ();
 665   3              while(1)
 666   3              {       
 667   4              if(m==6)beep=0;
 668   4              if(m==5)beep=1;
 669   4                  if(m==0)
 670   4                  {
 671   5                      if(0<money<50)
 672   5                      {
 673   6                          clrram_lcd ();
 674   6                          gotoxy(1,0);
C51 COMPILER V9.00   CHENGXU                                                               04/19/2020 18:38:59 PAGE 12  

 675   6                          print("投币不足购买失败");
 676   6                          mdelay(10);
 677   6                          gotoxy(2,0);
 678   6                          print("退钱：    元");
 679   6                          mdelay(10);
 680   6                          Time[0]=money/10+'0';
 681   6                          Time[1]='.';
 682   6                          Time[2]=money%10+'0';
 683   6                          Time[3]='\0';
 684   6                          gotoxy(2,3);
 685   6                          print(Time);
 686   6                          mdelay(6000);
 687   6                          money=0;
 688   6                      }
 689   5      
 690   5                      clrram_lcd ();
 691   5                      break;
 692   5                  }
 693   4      
 694   4                  gotoxy(1,0);
 695   4                  print("已选啤酒");
 696   4                  mdelay(10);
 697   4      
 698   4                  gotoxy(2,0);
 699   4                  print("货物价格:5元");
 700   4                  mdelay(10);
 701   4      
 702   4                  gotoxy(3,0);
 703   4                  print("投币金额:     元");
 704   4                  mdelay(10);
 705   4      
 706   4                  gotoxy(4,0);
 707   4                  print("规定时间：");
 708   4                  mdelay(10);
 709   4      
 710   4      
 711   4                  if(n==0)
 712   4                  {
 713   5                      gotoxy(3,5);
 714   5                      print(Time);
 715   5                      mdelay(100);
 716   5                  }
 717   4      
 718   4                  if(n==1)
 719   4                  {
 720   5                      gotoxy(4,7);
 721   5                      print(Time);
 722   5                      mdelay(10);
 723   5                  }
 724   4      
 725   4                  if(K1==0)
 726   4                  {
 727   5                      while(K1==0);
 728   5                      mdelay(10);
 729   5                      money=money+100;
 730   5                  }
 731   4      
 732   4                  if(K2==0)
 733   4                  {
 734   5                      while(K2==0);
 735   5                      mdelay(10);
 736   5                      money=money+50;
C51 COMPILER V9.00   CHENGXU                                                               04/19/2020 18:38:59 PAGE 13  

 737   5                  }
 738   4      
 739   4                  if(K3==0)
 740   4                  {
 741   5                      while(K3==0);
 742   5                      mdelay(10);
 743   5                      money=money+10;
 744   5                  }
 745   4                  if(money>=50)
 746   4                  {
 747   5                      clrram_lcd ();
 748   5                      gotoxy(1,0);
 749   5                      print("啤酒买成功");
 750   5                      mdelay(10);
 751   5                      gotoxy(2,0);
 752   5                      print("找钱：    元");
 753   5                      mdelay(10);
 754   5      
 755   5                      du=money-50;
 756   5                      Time[0]=du/10+'0';
 757   5                      Time[1]='.';
 758   5                      Time[2]=du%10+'0';
 759   5                      Time[3]='\0';
 760   5                      gotoxy(2,3);
 761   5                      print(Time);
 762   5                                      DJ=0;
 763   5                      mdelay(6000);
 764   5                                      DJ=1;
 765   5                      money=0;
 766   5                      clrram_lcd ();
 767   5                      break;
 768   5      
 769   5                  }
 770   4              }
 771   3                      }
 772   2          }
 773   1      
 774   1          if(K8==0)//按键5
 775   1          {  if(t5>0)
 776   2                      {
 777   3                         t5--;
 778   3              m=30;
 779   3              clrram_lcd ();
 780   3              while(1)
 781   3              {
 782   4      
 783   4                         if(m==6)beep=0;
 784   4                 if(m==5)beep=1;
 785   4                  if(m==0)
 786   4                  {
 787   5                      if(0<money<60)
 788   5                      {
 789   6                          clrram_lcd ();
 790   6                          gotoxy(1,0);
 791   6                          print("投币不足购买失败");
 792   6                          mdelay(10);
 793   6                          gotoxy(2,0);
 794   6                          print("退钱：    元");
 795   6                          mdelay(10);
 796   6                          Time[0]=money/10+'0';
 797   6                          Time[1]='.';
 798   6                          Time[2]=money%10+'0';
C51 COMPILER V9.00   CHENGXU                                                               04/19/2020 18:38:59 PAGE 14  

 799   6                          Time[3]='\0';
 800   6                          gotoxy(2,3);
 801   6                          print(Time);
 802   6                                               mdelay(6000);
 803   6                          money=0;
 804   6                      }
 805   5      
 806   5                      clrram_lcd ();
 807   5                      break;
 808   5                  }
 809   4      
 810   4                  gotoxy(1,0);
 811   4                  print("已选红牛");
 812   4                  mdelay(10);
 813   4      
 814   4                  gotoxy(2,0);
 815   4                  print("货物价格:6元");
 816   4                  mdelay(10);
 817   4      
 818   4                  gotoxy(3,0);
 819   4                  print("投币金额:     元");
 820   4                  mdelay(10);
 821   4      
 822   4                  gotoxy(4,0);
 823   4                  print("规定时间：");
 824   4                  mdelay(10);
 825   4      
 826   4      
 827   4                  if(n==0)
 828   4                  {
 829   5                      gotoxy(3,5);
 830   5                      print(Time);
 831   5                      mdelay(100);
 832   5                  }
 833   4      
 834   4                  if(n==1)
 835   4                  {
 836   5                      gotoxy(4,7);
 837   5                      print(Time);
 838   5                      mdelay(10);
 839   5                  }
 840   4      
 841   4                  if(K1==0)
 842   4                  {
 843   5                      while(K1==0);
 844   5                      mdelay(10);
 845   5                      money=money+100;
 846   5                  }
 847   4      
 848   4                  if(K2==0)
 849   4                  {
 850   5                      while(K2==0);
 851   5                      mdelay(10);
 852   5                      money=money+50;
 853   5                  }
 854   4      
 855   4                  if(K3==0)
 856   4                  {
 857   5                      while(K3==0);
 858   5                      mdelay(10);
 859   5                      money=money+10;
 860   5                  }
C51 COMPILER V9.00   CHENGXU                                                               04/19/2020 18:38:59 PAGE 15  

 861   4                  if(K1==0)
 862   4                  {
 863   5                      while(K1==0);
 864   5                      mdelay(10);
 865   5                      money=money+100;
 866   5                  }
 867   4      
 868   4                  if(K2==0)
 869   4                  {
 870   5                      while(K2==0);
 871   5                      mdelay(10);
 872   5                      money=money+50;
 873   5                  }
 874   4      
 875   4                  if(K3==0)
 876   4                  {
 877   5                      while(K3==0);
 878   5                      mdelay(10);
 879   5                      money=money+10;
 880   5                  }
 881   4                  if(money>=60)
 882   4                  {
 883   5                      clrram_lcd ();
 884   5                      gotoxy(1,0);
 885   5                      print("红牛买成功");
 886   5                      mdelay(10);
 887   5                      gotoxy(2,0);
 888   5                      print("找钱：    元");
 889   5                      mdelay(10);
 890   5      
 891   5                      du=money-60;
 892   5                      Time[0]=du/10+'0';
 893   5                      Time[1]='.';
 894   5                      Time[2]=du%10+'0';
 895   5                      Time[3]='\0';
 896   5                      gotoxy(2,3);
 897   5                      print(Time);
 898   5                                      DJ=0;
 899   5                      mdelay(6000);
 900   5                                      DJ=1;
 901   5                      money=0;
 902   5                      clrram_lcd ();
 903   5                      break;
 904   5      
 905   5                  }
 906   4              }
 907   3                      }
 908   2          }
 909   1      }
 910          
 911          void InitUART(void)
 912          {
 913   1          
 914   1              TMOD = 0x21;
 915   1          SCON = 0x50;
 916   1          TH1 = 0xFD;
 917   1          TL1 = TH1;
 918   1          PCON = 0x00;
 919   1          EA = 1;
 920   1          ES = 1;
 921   1          TR1 = 1;
 922   1      }
C51 COMPILER V9.00   CHENGXU                                                               04/19/2020 18:38:59 PAGE 16  

 923          
 924          void SendOneByte(unsigned char c)
 925          {
 926   1          SBUF = c;
 927   1          while(!TI);
 928   1          TI = 0;
 929   1      }
 930          
 931          void sendData(char *str)
 932          {
 933   1              int i =0;
 934   1              while(str[i] != '\0')
 935   1                      SendOneByte(str[i++]);
 936   1      }
 937          
 938          void configEsp8266()
 939          {
 940   1              static unsigned char count = 0;
 941   1              count++;
 942   1              if(count != 255)
 943   1              {
 944   2                      return;
 945   2              }
 946   1              count = 0;
 947   1              switch(configStep){
 948   2              case 0:
 949   2                      sendData(atTest);
 950   2                      break;
 951   2              case 1:
 952   2                      sendData(atMUX);
 953   2                      break;
 954   2              case 2:
 955   2                      sendData(atServer);
 956   2                      break;
 957   2              }
 958   1      }
 959          
 960          void sendListServer()
 961          {
 962   1              uchar listStr[6]={0};
 963   1              listStr[0]=t1;
 964   1              listStr[1]=t2;
 965   1              listStr[2]=t3;
 966   1              listStr[3]=t4;
 967   1              listStr[4]=t5;
 968   1              if(readFinish){
 969   2                      if(recvData[0]==0x01)
 970   2                      {
 971   3                              sendData(listStr);
 972   3                      }
 973   2              }
 974   1              
 975   1      
 976   1      }
 977          
 978          
 979          void UARTInterrupt(void) interrupt 4
 980          {
 981   1              static int i = 0;
 982   1              char recv = 0;
 983   1          if(RI)
 984   1          {
C51 COMPILER V9.00   CHENGXU                                                               04/19/2020 18:38:59 PAGE 17  

 985   2              RI = 0;
 986   2              //add your code here!
 987   2              recv = SBUF;
 988   2              if(recv=='#')
 989   2                      {
 990   3                              readFinish = 0;
 991   3                              i = 0;
 992   3                      }
 993   2                      else if(recv=='!')
 994   2                      {
 995   3                              readFinish = i;
 996   3                      }
 997   2                      else
 998   2                      {
 999   3                              recvData[i] = recv;
1000   3                              i++;
1001   3                      }
1002   2                      if(i == 50)
1003   2                      {
1004   3                              i = 0;
1005   3                      }
1006   2                      if(recv == 'O')
1007   2                      {
1008   3                              if(configStep < 3)
1009   3                                      configStep++;
1010   3                              show();
1011   3                      }
1012   2          }
1013   1      }
1014          
1015          
1016          
1017          //************************************
1018          //主程序
1019          //*************************************
1020          main()
1021          {
1022   1          TMOD=0x01;                                  //T0 工作在方式1 16位计数器
1023   1          TH0=(65536-50000)/256;      //预先 设定定时器 初值,50毫秒
1024   1          TL0=(65536-50000)%256;
1025   1          EA=1;                                               //开启 总中断
1026   1          ET0=1;                                              //开启定时器 0 中断
1027   1          TR0=1;                                              //定时器 0 启动计数
1028   1      
1029   1          init_lcd();
1030   1          clrram_lcd();
1031   1              InitUART();
1032   1              
1033   1      
1034   1          while(1)
1035   1          {
1036   2                
1037   2             key();
1038   2                 //sendData(info);
1039   2                 configEsp8266();
1040   2                 sendListServer();
1041   2      
1042   2          }
1043   1      }
1044          
1045          
1046          void time0(void)  interrupt 1
C51 COMPILER V9.00   CHENGXU                                                               04/19/2020 18:38:59 PAGE 18  

1047          {
1048   1          TH0=(65536-50000)/256;              //重新设置定时器 初值,产生50MS定时中断
1049   1          TL0=(65536-50000)%256;
1050   1          count++;                                    //50ms太短，闪烁频率太快
1051   1      
1052   1          if(count==10)
1053   1          {
1054   2              if(n==0)
1055   2              {
1056   3                  Time[0]=m/10+'0';
1057   3      
1058   3                  Time[1]=m%10+'0';
1059   3                  Time[2]='\0';
1060   3              }
1061   2              if(n==1)
1062   2              {
1063   3                  Time[0]=money/10+'0';
1064   3                  Time[1]='.';
1065   3                  Time[2]=money%10+'0';
1066   3      
1067   3              }
1068   2                      
1069   2      
1070   2              Time[3]='\0';
1071   2              Time[4]='\0';
1072   2      
1073   2              count=0;
1074   2      
1075   2              if(m==0)m=30;
1076   2      
1077   2              n++;
1078   2              if(n==2)
1079   2              {
1080   3                  m--;
1081   3                  n=0;
1082   3              }
1083   2                      
1084   2                 count=0;
1085   2              nn++;
1086   2              if(nn==20)
1087   2              {
1088   3                  nn=0;
1089   3              }
1090   2          }
1091   1      
1092   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2784    ----
   CONSTANT SIZE    =    358    ----
   XDATA SIZE       =    119       9
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
